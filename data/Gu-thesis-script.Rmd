---
title: 'parental migration and adolescents educational performance'
output: html_notebook
---

Load packages
```{r}
library(tidyverse) 
library(haven)
library(fixest)
library(modelsummary)
```

## Data cleaning
Read CEPS data
```{r}
d_stu1 <- read_dta('cepsw1studentCN.dta') #wave 1 student
d_stu2 <- read_dta('cepsw2studentCN.dta') #wave 2 student
d_par1 <- read_dta('cepsw1parentCN.dta') #wave 1 parent
d_par2 <- read_dta('cepsw2parentCN.dta') #wave 2 parent
#d_sch1 <- read_dta('cepsw1principalCN.dta') #wave 1 school principal
#d_sch2 <- read_dta('cepsw2principalCN.dta')
```

Remove wave 1's observations of grade 9; they were not followed up in wave 2
```{r}
d_stu1 <- d_stu1 %>% 
  subset(grade9==0) %>% 
  select(!c(frame, subsample, sweight, grade9))
d_stu2 <- d_stu2 %>% 
  select(!c(w2frame, w2subsample, w2sweight, w1w2sweight))
d_par1 <- d_par1 %>% 
  subset(grade9==0) %>% 
  select(!c(frame, subsample, grade9))
```

Assemble a panel dataset in wide format
```{r}
dw1 <- d_stu1 %>% left_join(d_par1, by=c('ids', 'clsids', 'schids', 'ctyids', 'fall')) 
#%>% left_join(d_sch1, by=c('schids', 'ctyids', 'fall'))
dw2 <- d_stu2 %>% left_join(d_par2, by=c('ids', 'clsids', 'w2clsids', 'schids', 'ctyids', 'w2fall'))
d <- dw1 %>% right_join(dw2, by=c('ids', 'clsids', 'schids', 'ctyids'))
```

```{r}
d <- d %>% mutate(
  age = 2013 - a02a, #student's age at baseline
  w1chn_100 = tr_chn/w2upchn*100, #raw exam scores at 100-point scale
  w1mat_100 = tr_mat/w2upmat*100,
  w1eng_100 = tr_eng/w2upeng*100,
  w2chn_100 = w2chn/w2upchn*100,
  w2mat_100 = w2mat/w2upmat*100,
  w2eng_100 = w2eng/w2upeng*100
)
d <- d %>% mutate(
  w1ttl = tr_chn + tr_mat + tr_eng,
  w2ttl = w2chn + w2mat + w2eng,
  w1ttl_100 = w1chn_100 + w1mat_100 + w1eng_100,
  w2ttl_100 = w2chn_100 + w2mat_100 + w2eng_100,
  ttl_dif = w2ttl_100 - w1ttl_100,
  cog_dif = w2cog3pl - cog3pl
  )
```

```{r}
d1 <- d %>% filter(w2ttl_100<=300 & w1ttl_100<=300) %>% #remove outliers with total scores greater than 300
  drop_na(cog_dif, ttl_dif, age)
```

within-class z score
```{}
d1 <- d1 %>% group_by(schids) %>%
  mutate(
    w1ttl_z = as.numeric(scale(w1ttl)),
    w2ttl_z = as.numeric(scale(w2ttl))
  ) %>% ungroup()
```

```{}
d1 <- d1 %>% group_by(schids) %>%
  mutate(
    w1ttl_std = rescale(w1ttl),
    w2ttl_std = rescale(w2ttl)
    ) %>% ungroup()
```

Detect outliers
```{}
d_outlier <- d %>% filter(w1chn_100 > 100 | w1mat_100>100|w1eng_100>100|w2chn_100>100|w2mat_100>100|w2eng_100>100)
d_outlier1 <- d_outlier %>% select(clsids, schids, tr_chn, tr_mat, tr_eng, w2chn, w2upchn, w2mat, w2upmat, w2eng, w2upeng)
d1 <- d %>% anti_join(d_outlier, by=c('ids', 'clsids', 'schids', 'ctyids'))
```

Sample
```{r}
d_cl <- d1 %>% 
  filter(w2a0801==1) %>% #keep parents who are married (and alive)
  filter(be1201==1 & be1202==1) %>% #keep both parents live with children at baseline
  filter(stmigrant==1) #keep local children 
```

## Variables 

Control variables
```{r}
d_cl <- d_cl %>% mutate(
         ch.girl = if_else(a01 == 2, 1, 0), #student is girl
         ch.rural = sthktype, #student holds rural (agricultural) hukou
         ch.boarding = stbrd, #student is boarding at school
         ch.ethn.mnrt = if_else(a03 != 1, 1, 0), #student is ethnic minority
         ch.health = a17, #student's self-rated health
         ch.skip.grd = if_else(c03 == 0, 0, 1), #student had skipped grade
         ch.repeat.grd = if_else(c04 == 0, 0, 1), #student had repeated grade
         ch.aspr.univ = if_else(c22 <= 6 | c22 == 10, 0, 1), #student aspires to finish university bachelor's degree or above
         #ch.illness = if_else(a10 == 1, 1, 0), #student had serious illness before primary school
         ch.preschool = if_else(c01 == 1, 1, 0), #student had attended preschool
         #ch.par.rltn = if_else(stprrel == 2, 1, 0),
         #ch.tutoring = if_else(b1901 == 1|b1902 == 1|b1903 == 1|b1904 == 1, 1, 0),
         par.expt.univ = if_else(ba18 <= 6, 0, 1), #parent expects child to finish university bachelor's degree or above
         par.edu = stprhedu, #Among two parents, the best-educated one's educational level
         par.ccp = if_else(be06 == 1, 1, 0), #At least one parent is communist party member
         home.finances = steco_5c, #self-rated household financial situation
         home.internet = if_else(b13 == 2, 1, 0), #student has internet access at home
         home.book = b12 #Amount of book at home, student self-rated 
) %>% drop_na(
ch.girl, ch.rural, ch.health, ch.boarding, ch.ethn.mnrt, ch.health, ch.skip.grd, ch.repeat.grd, ch.preschool, ch.aspr.univ, par.edu, par.ccp, par.expt.univ, home.internet, home.book, home.finances)
```

```{r}
d_cl$stsib <- d_cl$stsib %>% replace_na(0) %>% as.numeric()
d_cl <- d_cl %>% mutate(ch.sibling = if_else(stonly == 1, 0, stsib)) %>% #number of siblings
  drop_na(ch.sibling)
```

Best-educated parent's years of education
```{r}
d_cl <- d_cl %>% mutate(par.edu.year = NA)
d_cl$par.edu.year[d_cl$par.edu == 1] <- 0
d_cl$par.edu.year[d_cl$par.edu == 2] <- 6
d_cl$par.edu.year[d_cl$par.edu == 3] <- 9
d_cl$par.edu.year[d_cl$par.edu == 4|d_cl$par.edu == 5|d_cl$par.edu == 6] <- 12
d_cl$par.edu.year[d_cl$par.edu == 7] <- 15
d_cl$par.edu.year[d_cl$par.edu == 8] <- 16
d_cl$par.edu.year[d_cl$par.edu == 9] <- 19
```

```
d_cl <- d_cl %>% mutate(fa.edu.year = NA)
d_cl$fa.edu.year[d_cl$fa.edu == 1] <- 0
d_cl$fa.edu.year[d_cl$fa.edu == 2] <- 6
d_cl$fa.edu.year[d_cl$fa.edu == 3] <- 9
d_cl$fa.edu.year[d_cl$fa.edu == 4|d_cl$fa.edu == 5|d_cl$fa.edu == 6] <- 12
d_cl$fa.edu.year[d_cl$fa.edu == 7] <- 15
d_cl$fa.edu.year[d_cl$fa.edu == 8] <- 16
d_cl$fa.edu.year[d_cl$fa.edu == 9] <- 19
```

```
d_cl <- d_cl %>% mutate(mo.edu.year = NA)
d_cl$mo.edu.year[d_cl$mo.edu == 1] <- 0
d_cl$mo.edu.year[d_cl$mo.edu == 2] <- 6
d_cl$mo.edu.year[d_cl$mo.edu == 3] <- 9
d_cl$mo.edu.year[d_cl$mo.edu == 4|d_cl$mo.edu == 5|d_cl$mo.edu == 6] <- 12
d_cl$mo.edu.year[d_cl$mo.edu == 7] <- 15
d_cl$mo.edu.year[d_cl$mo.edu == 8] <- 16
d_cl$mo.edu.year[d_cl$mo.edu == 9] <- 19
```

## Treatment groups
At least one parent migrated (Control group as no parent migrated)
```{r}
d_cl <- d_cl %>% mutate(
  migr = if_else((w2ba0201==0 | w2ba0202==0), 1, 0), #Any parent became absent from household between baseline and endline survey
  migr_fa_only = NA,
  migr_fa = NA,
  migr_mo_only = NA,
  migr_mo = NA,
  migr_both = NA
  ) %>% drop_na(migr)
```

Only mother migrated
```{r}
d_cl$migr_mo_only[d_cl$migr == 0] <- 0
d_cl$migr_mo_only[d_cl$w2ba0201==1 & d_cl$w2ba0202==0] <- 1 
```

Mother migrated
```{r}
d_cl$migr_mo[d_cl$migr == 0] <- 0
d_cl$migr_mo[d_cl$w2ba0202==0] <- 1
```

Only father migrated
```{r}
d_cl$migr_fa_only[d_cl$migr == 0] <- 0
d_cl$migr_fa_only[d_cl$w2ba0201==0 & d_cl$w2ba0202==1] <- 1 
```

Father migrated
```{r}
d_cl$migr_fa[d_cl$migr == 0] <- 0
d_cl$migr_fa[d_cl$w2ba0201==0] <- 1
```

Both parents migrated
```{r}
d_cl$migr_both[d_cl$migr == 0] <- 0
d_cl$migr_both[d_cl$w2ba0201==0 & d_cl$w2ba0202==0] <- 1
```

```{r}
df <- d_cl %>% select(
  migr, migr_fa_only, migr_fa, migr_mo_only, migr_mo, migr_both,
  cog3pl, w1ttl_100, cog_dif, ttl_dif,
  ch.girl, ch.rural, ch.health, ch.boarding, ch.ethn.mnrt, ch.health, ch.skip.grd, ch.repeat.grd, ch.preschool, ch.aspr.univ, 
  par.edu, par.ccp, par.expt.univ, 
  home.internet, home.book, home.finances
)
```


## Descriptive statistics
```{r}
d_migr <- d_cl %>% select(
  migr, migr_fa_only, migr_fa, migr_mo_only, migr_mo, migr_both) %>%
  mutate_if(is.numeric, as.factor)
datasummary_skim(
  d_migr,
  type='categorical')
```

```{r}
d_covar <- d_cl %>% select(
  ch.girl, ch.rural, ch.health, ch.boarding, ch.ethn.mnrt, ch.health, ch.skip.grd, ch.repeat.grd, ch.preschool, ch.aspr.univ, 
  par.edu.year, par.ccp, par.expt.univ, 
  home.internet, home.book, home.finances) %>%
  mutate_if(is.numeric, as.factor)
datasummary_skim(
  d_covar,
  type ='categorical',
  output = "table.md")

```


t-test
```{r}
t.test(cog_dif ~ migr, data = d_cl)
t.test(ttl_dif ~ migr, data = d_cl)
```


## Descriptive statistics


## DID unrestricted
Regressing on cognitive test score (standardized)
```{r}
did_unres_cog <- feols(cog_dif ~ migr + cog3pl | clsids, data = d_cl) 
did_unres_cog_m_only <- feols(cog_dif ~ migr_mo_only + cog3pl | clsids, data = d_cl) 
did_unres_cog_m <- feols(cog_dif ~ migr_mo + cog3pl | clsids, data = d_cl) 
did_unres_cog_f_only <- feols(cog_dif ~ migr_fa_only + cog3pl | clsids, data = d_cl) 
did_unres_cog_f <- feols(cog_dif ~ migr_fa + cog3pl | clsids, data = d_cl) 
did_unres_cog_both <- feols(cog_dif ~ migr_both + cog3pl | clsids, data = d_cl)
```

Results
```{r}
models_unres_cog <- list(
'Any Parent Absent' = did_unres_cog,
'Only Mother Absent' = did_unres_cog_m_only,
'Mother Absent' = did_unres_cog_m,
'Only Father Absent' = did_unres_cog_f_only,
'Father Absent' = did_unres_cog_f,
'Both Parents Absent' = did_unres_cog_both) 
table_unres_cog <- models_unres_cog %>% msummary(
  stars =  c('†' = .1, '*' = .05, '**' = .01, '***' = .001),
  fmt = 2,
  title = 'Parental migration’s effect on children’s cognitive abilities',
  coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "cog3pl" = "W1 score"), output = 'markdown')
table_unres_cog
```

raw score
```{r}
did_unres_ttl <- feols(ttl_dif ~ migr + w1ttl_100 | clsids, data = d_cl) 
did_unres_ttl_m_only <- feols(ttl_dif ~ migr_mo_only + w1ttl_100 | clsids, data = d_cl) 
did_unres_ttl_m <- feols(ttl_dif ~ migr_mo + w1ttl_100 | clsids, data = d_cl) 
did_unres_ttl_f_only <- feols(ttl_dif ~ migr_fa_only + w1ttl_100 | clsids, data = d_cl) 
did_unres_ttl_f <- feols(ttl_dif ~ migr_fa + w1ttl_100 | clsids, data = d_cl) 
did_unres_ttl_both <- feols(ttl_dif ~ migr_both + w1ttl_100 | clsids, data = d_cl)
```

```{r}
models_unres_ttl <- list(
'Any Parent Absent' = did_unres_ttl,
'Only Mother Absent' = did_unres_ttl_m_only,
'Mother Absent' = did_unres_ttl_m,
'Only Father Absent' = did_unres_ttl_f_only,
'Father Absent' = did_unres_ttl_f,
'Both Parents Absent' = did_unres_ttl_both) 
table_unres_ttl <- models_unres_ttl %>% msummary(
  stars =  c('†' = .1, '*' = .05, '**' = .01, '***' = .001), 
  title = 'Parental migration’s effect on children’s academic abilities',
  fmt = 2,
  coef_rename = c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_100" = "W1 score"), output = 'markdown')
table_unres_ttl
```

z score
```{}
did_unres_ttl_z <- feols(ttl_z_dif ~ migr + w1ttl_z | clsids, data = d_cl) 
did_unres_ttl_z_m_only <- feols(ttl_z_dif ~ migr_mo_only + w1ttl_z | clsids, data = d_cl) 
did_unres_ttl_z_m <- feols(ttl_z_dif ~ migr_mo + w1ttl_z | clsids, data = d_cl) 
did_unres_ttl_z_f_only <- feols(ttl_z_dif ~ migr_fa_only + w1ttl_z | clsids, data = d_cl) 
did_unres_ttl_z_f <- feols(ttl_z_dif ~ migr_fa + w1ttl_z | clsids, data = d_cl) 
did_unres_ttl_z_both <- feols(ttl_z_dif ~ migr_both + w1ttl_z | clsids, data = d_cl)
```

```{}
models_unres_ttl_z <- list(
'Any Parent Absent' = did_unres_ttl_z,
'Only Mother Absent' = did_unres_ttl_z_m_only,
'Mother Absent' = did_unres_ttl_z_m,
'Only Father Absent' = did_unres_ttl_z_f_only,
'Father Absent' = did_unres_ttl_z_f,
'Both Parents Absent' = did_unres_ttl_z_both) 
table_unres_ttl_z <- models_unres_ttl_z %>% msummary(stars = c('*' = .05, '**' = .01, '***' = .001), 
                              fmt = 2,
                              coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_dif" = "Baseline difference"), output = 'markdown')
table_unres_ttl_z
```

std
```{}
did_unres_ttl_std <- feols(ttl_std_dif ~ migr + w1ttl_std | clsids, data = d_cl) 
did_unres_ttl_std_m_only <- feols(ttl_std_dif ~ migr_mo_only + w1ttl_std | clsids, data = d_cl) 
did_unres_ttl_std_m <- feols(ttl_std_dif ~ migr_mo + w1ttl_std | clsids, data = d_cl) 
did_unres_ttl_std_f_only <- feols(ttl_std_dif ~ migr_fa_only + w1ttl_std | clsids, data = d_cl) 
did_unres_ttl_std_f <- feols(ttl_std_dif ~ migr_fa + w1ttl_std | clsids, data = d_cl) 
did_unres_ttl_std_both <- feols(ttl_std_dif ~ migr_both + w1ttl_std | clsids, data = d_cl)
```

```{}
models_unres_ttl_std <- list(
'Any Parent Absent' = did_unres_ttl_std,
'Only Mother Absent' = did_unres_ttl_std_m_only,
'Mother Absent' = did_unres_ttl_std_m,
'Only Father Absent' = did_unres_ttl_std_f_only,
'Father Absent' = did_unres_ttl_std_f,
'Both Parents Absent' = did_unres_ttl_std_both) 
table_unres_ttl_std <- models_unres_ttl_std %>% msummary(stars = c('*' = .05, '**' = .01, '***' = .001), 
                              fmt = 2,
                              coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_dif" = "Baseline difference"), output = 'markdown')
table_unres_ttl_std
```

dif to mean
```{}
did_unres_ttl_dm <- feols(ttl_dm_dif ~ migr + w1ttl_100_dm | clsids, data = d_cl) 
did_unres_ttl_dm_m_only <- feols(ttl_dm_dif ~ migr_mo_only + w1ttl_100_dm | clsids, data = d_cl) 
did_unres_ttl_dm_m <- feols(ttl_dm_dif ~ migr_mo + w1ttl_100_dm | clsids, data = d_cl) 
did_unres_ttl_dm_f_only <- feols(ttl_dm_dif ~ migr_fa_only + w1ttl_100_dm | clsids, data = d_cl) 
did_unres_ttl_dm_f <- feols(ttl_dm_dif ~ migr_fa + w1ttl_100_dm | clsids, data = d_cl) 
did_unres_ttl_dm_both <- feols(ttl_dm_dif ~ migr_both + w1ttl_100_dm | clsids, data = d_cl)
```


```{}
models_unres_ttl_dm <- list(
'Any Parent Absent' = did_unres_ttl_dm,
'Only Mother Absent' = did_unres_ttl_dm_m_only,
'Mother Absent' = did_unres_ttl_dm_m,
'Only Father Absent' = did_unres_ttl_dm_f_only,
'Father Absent' = did_unres_ttl_dm_f,
'Both Parents Absent' = did_unres_ttl_dm_both) 
table_unres_ttl_dm <- models_unres_ttl_dm %>% msummary(stars = c('*' = .05, '**' = .01, '***' = .001), 
                              fmt = 2,
                              coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_dif" = "Baseline difference"), output = 'markdown')
table_unres_ttl_dm
```

## DID adjusted unrestricted
$$\Delta score_{i,s} = \alpha + \beta \cdot migr_{i,s} + \gamma \cdot FE_{s} + \lambda \cdot score_{i,s;base} + \theta \cdot X_{i,s} + \varepsilon_{i,s}$$

Regressing on cognitive test score (standardized)
```{r}
did_adj_unres_cog <- feols(cog_dif ~ migr + cog3pl  + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book  + home.internet | clsids, data = d_cl) 
did_adj_unres_cog_m_only <- feols(cog_dif ~ migr_mo_only + cog3pl  + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book  + home.internet | clsids, data = d_cl) 
did_adj_unres_cog_m <- feols(cog_dif ~ migr_mo + cog3pl  + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book  + home.internet | clsids, data = d_cl) 
did_adj_unres_cog_f_only <- feols(cog_dif ~ migr_fa_only + cog3pl  + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book  + home.internet | clsids, data = d_cl) 
did_adj_unres_cog_f <- feols(cog_dif ~ migr_fa + cog3pl  + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book  + home.internet | clsids, data = d_cl) 
did_adj_unres_cog_both <- feols(cog_dif ~ migr_both + cog3pl  + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book  + home.internet | clsids, data = d_cl)
```

Results
```{r}
models_adj_unres_cog <- list(
'Any Parent Absent' = did_adj_unres_cog,
'Only Mother Absent' = did_adj_unres_cog_m_only,
'Mother Absent' = did_adj_unres_cog_m,
'Only Father Absent' = did_adj_unres_cog_f_only,
'Father Absent' = did_adj_unres_cog_f,
'Both Parents Absent' = did_adj_unres_cog_both) 
table_adj_unres_cog <- models_adj_unres_cog %>% 
  msummary(stars =  c('†' = .1, '*' = .05, '**' = .01, '***' = .001),
           title = 'Parental migration’s effect on children’s cognitive abilities',
           fmt = 2,
           coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "cog3pl" = "W1 score"), output = 'markdown')
table_adj_unres_cog
```

Regressing on total exam score
```{r}
did_adj_unres_ttl <- feols(ttl_dif ~ migr + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_m_only <- feols(ttl_dif ~ migr_mo_only + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_m <- feols(ttl_dif ~ migr_mo + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_f <- feols(ttl_dif ~ migr_fa + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_f_only <- feols(ttl_dif ~ migr_fa_only + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_both <- feols(ttl_dif ~ migr_both + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl)
```

Results
```{r}
models_adj_unres_ttl <- list(
'Any Parent Absent' = did_adj_unres_ttl,
'Only Mother Absent' = did_adj_unres_ttl_m_only,
'Mother Absent' = did_adj_unres_ttl_m,
'Only Father Absent' = did_adj_unres_ttl_f_only,
'Father Absent' = did_adj_unres_ttl_f,
'Both Parents Absent' = did_adj_unres_ttl_both) 
table_adj_unres_ttl <- models_adj_unres_ttl %>% msummary(
  stars =  c('†' = .1, '*' = .05, '**' = .01, '***' = .001), 
  title = 'Parental migration’s effect on children’s academic abilities',
  fmt = 2, 
  coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_100" = "W1 score"), output = 'markdown')
table_adj_unres_ttl
```

Regressing on total exam score
```{}
did_adj_unres_ttl_z <- feols(ttl_z_dif ~ migr + w1ttl_z + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_z_m_only <- feols(ttl_z_dif ~ migr_mo_only + w1ttl_z + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_z_m <- feols(ttl_z_dif ~ migr_mo + w1ttl_z + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_z_f <- feols(ttl_z_dif ~ migr_fa + w1ttl_z + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_z_f_only <- feols(ttl_z_dif ~ migr_fa_only + w1ttl_z + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_z_both <- feols(ttl_z_dif ~ migr_both + w1ttl_z + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl)
```

Results
```{}
models_adj_unres_ttl_z <- list(
'Any Parent Absent' = did_adj_unres_ttl_z,
'Only Mother Absent' = did_adj_unres_ttl_z_m_only,
'Mother Absent' = did_adj_unres_ttl_z_m,
'Only Father Absent' = did_adj_unres_ttl_z_f_only,
'Father Absent' = did_adj_unres_ttl_z_f,
'Both Parents Absent' = did_adj_unres_ttl_z_both) 
table_adj_unres_ttl_z <- models_adj_unres_ttl_z %>% msummary(stars = c('*' = .05, '**' = .01, '***' = .001), fmt = 2, coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_dif" = "Baseline difference"), output = 'markdown')
table_adj_unres_ttl_z
```

Regressing on total exam score
```{}
did_adj_unres_ttl_dm <- feols(ttl_dm_dif ~ migr + w1ttl_100_dm + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_dm_m_only <- feols(ttl_dm_dif ~ migr_mo_only + w1ttl_100_dm + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_dm_m <- feols(ttl_dm_dif ~ migr_mo + w1ttl_100_dm + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_dm_f <- feols(ttl_dm_dif ~ migr_fa + w1ttl_100_dm + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_dm_f_only <- feols(ttl_dm_dif ~ migr_fa_only + w1ttl_100_dm + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl) 
did_adj_unres_ttl_dm_both <- feols(ttl_dm_dif ~ migr_both + w1ttl_100_dm + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_cl)
```

Results
```{}
models_adj_unres_ttl_dm <- list(
'Any Parent Absent' = did_adj_unres_ttl_dm,
'Only Mother Absent' = did_adj_unres_ttl_dm_m_only,
'Mother Absent' = did_adj_unres_ttl_dm_m,
'Only Father Absent' = did_adj_unres_ttl_dm_f_only,
'Father Absent' = did_adj_unres_ttl_dm_f,
'Both Parents Absent' = did_adj_unres_ttl_dm_both) 
table_adj_unres_ttl_dm <- models_adj_unres_ttl_dm %>% msummary(stars = c('*' = .05, '**' = .01, '***' = .001), fmt = 2, coef_rename =  c("migr" = "Explanator", "migr_mo_only" = "Explanator", "migr_mo" = "Explanator", "migr_fa" = "Explanator", "migr_fa_only" = "Explanator", "migr_both" = "Explanator", "w1ttl_dif" = "Baseline difference"), output = 'markdown')
table_adj_unres_ttl_dm
```

## Matching
```{r}
m.out <- matchit(migr ~ age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet, data = d_cl, method = "cem")
summary(m.out, un = FALSE)
```

```{r}
d_match <- match.data(m.out)
```

```{r}
feols(cog_dif ~ migr + cog3pl + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet | clsids, data = d_match, weights = d_match$weights) %>% 
  msummary(stars = c('*' = .05, '**' = .01, '***' = .001), 
           fmt = 2)
feols(ttl_dif ~ migr + w1ttl_100 + age + ch.girl + ch.health + ch.rural + ch.sibling + ch.preschool + ch.skip.grd + ch.repeat.grd + ch.boarding + ch.aspr.univ + ch.ethn.mnrt + par.edu.year + par.expt.univ + par.ccp + home.finances + home.book + home.internet  | clsids, data = d_match, weights = d_match$weights) %>% 
  msummary(stars = c('*' = .05, '**' = .01, '***' = .001), 
           fmt = 2)
```

```{r}
datasummary_skim(d_asp)
```

